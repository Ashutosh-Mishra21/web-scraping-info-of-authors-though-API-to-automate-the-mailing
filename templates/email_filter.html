{% extends "universalLayout.html" %}

{% block head %}
<title>Email Filter - Pulsus</title>
{% endblock %}

{% block hero_title %}<i class="bi bi-funnel"></i> Email Filter{% endblock %}
{% block hero_subtitle %}Filter out invalid email addresses from your CSV files<br>This only gonna run in <b>Company
    LAN</b><br>Cause many residential ISP's, public WIFI providers, and especially mobile carriers(for hotspots)
<b>block outgoing connections on port 25</b>.{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Form Section -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-funnel"></i> Filter Email Addresses
            </div>
            <div class="card-body p-4">
                <form id="emailFilterForm" action="/email-filter/process" method="post" enctype="multipart/form-data">
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="bi bi-file-earmark-text"></i> Upload Data File</h5>
                        <div class="mb-3">
                            <label for="csv_file" class="form-label required-field">CSV File</label>
                            <input type="file" class="form-control" id="csv_file" name="csv_file"
                                accept=".csv,.xlsx,.xls,.xlsn,.xlsb,.xltm,.xltx" required>
                            <div class="form-text">Must contain a column named 'emails', . and the acceptable
                                extensions: .csv,.xlsx,.xls,.xlsn,.xlsb,.xltm,.xltx</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="col-md-6 mb-3">
                            <label for="sender_email" class="form-label required-field">Your Email</label>
                            <input type="email" class="form-control" id="sender_email" name="sender_email" required
                                placeholder="your.email@example.com">
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-funnel"></i> Filter Emails
                        </button>
                    </div>
                </form>
            </div>
        </div>





        <!-- Loading Spinner -->
        <div class="loading-container" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h5>Filtering emails, please wait...</h5>
                <p class="text-muted">This may take a while depending on the number of email addresses.</p>
            </div>
        </div>

        <!-- Results Output -->
        <div class="output-container" id="outputContainer">
            <div class="output-header">
                <i class="bi bi-clipboard-check"></i> Results
            </div>
            <div id="resultsOutput">
                <!-- Results will be displayed here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // DOM Elements
        const emailFilterForm = document.getElementById('emailFilterForm');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const outputContainer = document.getElementById('outputContainer');
        const resultsOutput = document.getElementById('resultsOutput');
        const submitBtn = document.getElementById('submitBtn');
        const alertContainer = document.getElementById('alertContainer');

        // Show alert notification
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alertElement = alertContainer.querySelector('.alert');
                if (alertElement) {
                    const bsAlert = new bootstrap.Alert(alertElement);
                    bsAlert.close();
                }
            }, 5000);
        }

        // Form submission
        emailFilterForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            // Clear previous results
            resultsOutput.innerHTML = '';
            outputContainer.style.display = 'none';

            // Show loading spinner
            loadingSpinner.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    resultsOutput.innerHTML = `<div class="alert alert-danger">Error ${response.status}: ${errorText}</div>`;
                    showAlert('Error filtering emails. Please try again.', 'danger');
                    return;
                }

                // Get the filename from the response headers
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'filtered_emails.csv';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch.length === 2) {
                        filename = filenameMatch[1];
                    }
                }

                // Create a blob from the response
                const blob = await response.blob();

                // Create a download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showAlert('Email filtering completed successfully!', 'success');
                resultsOutput.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> Your filtered CSV file has been downloaded.
                    </div>
                `;
            } catch (error) {
                console.error('Fetch error:', error);
                resultsOutput.innerHTML = `<div class="alert alert-danger">An error occurred: ${error.message}</div>`;
                showAlert('Network error. Please try again later.', 'danger');
            } finally {
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                outputContainer.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-funnel"></i> Filter Emails';
            }
        });
    });
</script>
{% endblock %}
