{% extends "universalLayout.html" %}
{% block head %}
<title>Email Scraper - Pulsus</title>
{% endblock %}
{% block hero_title %}<i class="bi bi-search"></i> Email Scraper{% endblock %}
{% block hero_subtitle %}Scrape author emails from PubMed based on search terms{% endblock %}
{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Alert Container -->
        <div id="alertContainer"></div>
        <!-- Form Section -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-search"></i> Scrape Author Emails
            </div>
            <div class="card-body p-4">
                <form id="emailScraperForm" action="/email-scraper/scrape" method="post">
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="bi bi-input-cursor-text"></i> Search Parameters</h5>
                        <div class="mb-3">
                            <label for="search_term" class="form-label required-field">Search Term</label>
                            <input type="text" class="form-control" id="search_term" name="search_term" required
                                placeholder="e.g., cancer research">
                            <div class="form-text">Enter keywords to search for in PubMed articles</div>
                        </div>
                        <div class="mb-3">
                            <label for="max_authors" class="form-label">Maximum Authors</label>
                            <input type="number" class="form-control" id="max_authors" name="max_authors" value="10000"
                                min="1" max="100000">
                            <div class="form-text">Maximum number of authors to retrieve (default: 10000, max: 100000)
                            </div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-search"></i> Scrape Emails
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Loading Spinner -->
        <div class="loading-container" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h5>Scraping emails, please wait...</h5>
                <p class="text-muted">This may take a while depending on the search results.</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                        style="width: 0%"></div>
                </div>
                <div class="mt-2 text-muted" id="progressText">Starting...</div>
            </div>
        </div>
        <!-- Results Output -->
        <div class="output-container" id="outputContainer">
            <div class="output-header">
                <i class="bi bi-clipboard-check"></i> Results
            </div>
            <div id="resultsOutput">
                <!-- Results will be displayed here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // DOM Elements
        const emailScraperForm = document.getElementById('emailScraperForm');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const outputContainer = document.getElementById('outputContainer');
        const resultsOutput = document.getElementById('resultsOutput');
        const submitBtn = document.getElementById('submitBtn');
        const alertContainer = document.getElementById('alertContainer');
        const progressBar = document.querySelector('.progress-bar');
        const progressText = document.getElementById('progressText');

        // Show alert notification
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alertElement = alertContainer.querySelector('.alert');
                if (alertElement) {
                    const bsAlert = new bootstrap.Alert(alertElement);
                    bsAlert.close();
                }
            }, 5000);
        }

        // Update progress
        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
        }

        // Form submission
        emailScraperForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            // Clear previous results
            resultsOutput.innerHTML = '';
            outputContainer.style.display = 'none';
            // Show loading spinner
            loadingSpinner.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

            // Initialize progress
            updateProgress(0, 'Initializing...');

            const form = event.target;
            const formData = new FormData(form);

            try {
                // Simulate progress updates (in a real app, you'd get this from the server)
                const progressInterval = setInterval(() => {
                    const currentWidth = parseInt(progressBar.style.width);
                    if (currentWidth < 90) {
                        updateProgress(currentWidth + 10, `Processing... ${currentWidth + 10}%`);
                    }
                }, 2000);

                const response = await fetch(form.action, {
                    method: form.method,
                    body: formData
                });

                clearInterval(progressInterval);
                updateProgress(100, 'Complete!');

                if (!response.ok) {
                    const errorText = await response.text();
                    resultsOutput.innerHTML = `<div class="alert alert-danger">Error ${response.status}: ${errorText}</div>`;
                    showAlert('Error scraping emails. Please try again.', 'danger');
                    return;
                }

                // Get the filename from the response headers
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'scraped_authors.csv';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch.length === 2) {
                        filename = filenameMatch[1];
                    }
                }

                // Create a blob from the response
                const blob = await response.blob();

                // Create a download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showAlert('Email scraping completed successfully!', 'success');
                resultsOutput.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> Your scraped data has been downloaded as a CSV file.
                    </div>
                `;
            } catch (error) {
                console.error('Fetch error:', error);
                resultsOutput.innerHTML = `<div class="alert alert-danger">An error occurred: ${error.message}</div>`;
                showAlert('Network error. Please try again later.', 'danger');
            } finally {
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                outputContainer.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-search"></i> Scrape Emails';
            }
        });
    });
</script>
{% endblock %}
